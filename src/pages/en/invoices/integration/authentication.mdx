# Authentication

To interact with the ***Payment orders management API*** you must authenticate your requests. This allows us to identify and validate the information to ensure your operations are secure.
The API uses **Web Services Security Username Token Profile 1.1**.

## API Credentials

When integrating with this API, you must have the consumer credentials: **login** and **secretKey**.

- **login:** Site identifier, it can be considered public since it is sent as plain data in API requests.
- **secretKey:** Site’s secret key, must be kept private. From this value, a new `tranKey` will be generated and sent in the requests.

<Note>
    These credentials are unique to the site and must be handled securely.
    Do not share your credentials in publicly accessible areas such as Github, client-side code, or any other place easily accessible to third parties.
</Note>

## Authentication Object {{ id: 'authentication-object' }}

The `auth` parameter must be sent in every API request and contains the set of properties required to verify authentication.

<Row>
    <Col>
        <Properties>
            <Property name="auth.login" type="string">
                Site identifier
            </Property>
            <Property name="auth.tranKey" type="string">
                Generated tranKey credential. Explained in detail below.
            </Property>
            <Property name="auth.nonce" type="string">
                Random value for each request encoded in Base64.
            </Property>
            <Property name="auth.seed" type="string">
                Current date, generated in ISO 8601 format.
            </Property>
        </Properties>
    </Col>
    <Col sticky>

        ```json {{ 'title': 'Authentication Example' }}
        {
            "auth": {
                "login":"aabbccdd1234567890aabbccdd123456",
                "tranKey":"ABC123example456trankey+789abc012def3456ABC=",
                "nonce":"enQ4dXh3YWhkMWM=",
                "seed":"2023-06-21T09:56:06-05:00"
            },
            ...
        }

        ```

    </Col>
</Row>

## How to generate your authentication {{ id: 'how-to-generate-your-authentication' }}

You need to prepare the following data:

**login:** The `login` credential provided when starting your integration. Site identifier.

**secretKey**: The `secretKey` credential provided when starting your integration. Site’s secret key.

**seed:** The date when the authentication was generated. Must follow ISO 8601 format.
Example: `2023-06-21T09:56:06-05:00`

**nonce:** Arbitrary value that uniquely identifies a request.
It is generated and used for other operations.
When sent, it must be encoded in Base64.
Example: `base64('927342197')`

**tranKey:** Generated programmatically for each request.
It is built with the following formula:
`Base64(SHA-256(nonce + seed + secretKey))`
This formula must be implemented depending on the programming language used.

<CodeGroup title="Generate authentication">

    ```php
    $login = "siteLogin";
    $secretKey = "siteSecretKey";
    $seed = date('c');
    $rawNonce = rand();

    $tranKey = base64_encode(hash('sha256', $rawNonce.$seed.$secretKey, true));
    $nonce = base64_encode($rawNonce);

    $body = [
        "auth" => [
            "login" => $login,
            "tranKey" => $tranKey,
            "nonce" => $nonce,
            "seed" => $seed,
        ],
        // ... other params
    ];
    ```

    ```js
    const crypto = require('crypto');

    const login = "siteLogin";
    const secretKey = "siteSecretKey";
    const seed = new Date().toISOString();
    const rawNonce = Math.floor(Math.random() * 1000000);

    const tranKey = Buffer.from(crypto.createHash('sha256').update(rawNonce + seed + secretKey).digest(), 'binary').toString('base64');
    const nonce = Buffer.from(rawNonce.toString()).toString('base64');

    const body = {
        auth: {
            login: login,
            tranKey: tranKey,
            nonce: nonce,
            seed: seed,
        },
        // ... other params
    };
    ```

    ```python
    import base64, hashlib, random, datetime

    login = "siteLogin"
    secret_key = "siteSecretKey"

    seed = datetime.datetime.now(datetime.timezone.utc).isoformat()
    raw_nonce = random.getrandbits(128).to_bytes(16, byteorder="big")
    nonce = base64.b64encode(raw_nonce).decode("utf-8")
    tran_key = base64.b64encode(hashlib.sha256(raw_nonce + seed.encode() + secret_key.encode()).digest()).decode("utf-8")

    return {
        "login": login,
        "tranKey": tran_key,
        "nonce": nonce,
        "seed": seed,
    }
    ```

</CodeGroup>

## Posibles errores de autenticación

| Código | Causa                                                                       |
|--------|-----------------------------------------------------------------------------|
| 100    | UsernameToken no proporcionado (Encabezado de la autorización mal formada). |
| 101    | El identificador del consumidor no existe.                                  |
| 102    | El hash de TranKey no coincide, puede ser incorrecto o mal formado.         |
| 103    | Fecha del seed mayor de 5 minutos.                                          |
| 104    | Consumidor inactivo                                                         |

